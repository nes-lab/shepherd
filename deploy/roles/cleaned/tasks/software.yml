---

- name: Optimize Boot by removing outdated initrd - find files with Wildcard
  # similar to "rm -rf /boot/initrd.img*"
  ansible.builtin.find:
    paths: '/boot'
    patterns: 'initrd.img*'
  register: files_init
- name: Optimize Boot by removing outdated initrd - delete files found previously
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items: "{{ files_init.files | map(attribute='path') }}"

- name: Delete unused firmware (by beaglebone, slightly risky) - A
  ansible.builtin.file:
    path: "/lib/firmware/{{ item }}"
    state: absent
  loop: # sorted by size, all ~ 360 mb
    - "netronome"
    - "amdgpu"
    - "intel"
    - "liquidio"
    - "qcom"
    - "qed"
    - "brcm"
    - "ath10k"
    - "mellanox"
    - "mrvl"
    - "i915"
    - "radeon"
    - "mediatek"
    - "nvidia"
  become: true

- name: Find unused firmware (by beaglebone, slightly risky) - B
  ansible.builtin.find:
    paths: '/lib/firmware/'
    patterns: 'iwlwifi-*' # > 100 mb, wifi-blobs
  register: files_fw
- name: Delete unused firmware (by beaglebone, slightly risky) - B
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items: "{{ files_fw.files | map(attribute='path') }}"
  when: false # TODO: Disabled for now, needs testing

- name: Uname - Get Kernel-Version
  ansible.builtin.command: 'uname --kernel-release'
  register: kernelrelease
  changed_when: false
- name: Inform about Kernel-Version
  ansible.builtin.debug:
    msg:
      - "active   = {{ kernelrelease.stdout.strip() }}"
      - "required = {{ required_kernel_regex }} (regex)"
- name: Check for required Kernel-Version
  ansible.builtin.fail:
    msg: |
      Required Kernel-Version not active!
      -> update_kernel.sh failed or /boot/uEnv.txt got changed
  when: kernelrelease.stdout.strip() is not ansible.builtin.search(required_kernel_regex)
  # TODO: a wrong version should disable the apt-task below (bricks the image)

- name: APT - Uninstall non-essential Packages
  ansible.builtin.apt:
    name: "{{ item }}"
    state: absent
    purge: true
  failed_when: false
  with_items:
    - "{{ non_essential_packages_a }}"
    - "{{ non_essential_packages_b }}"
    - "{{ non_essential_packages_c }}"
    - "{{ non_essential_packages_d }}"
    - "{{ non_essential_packages_e }}"
    - "{{ non_essential_packages_f }}"
    - "{{ non_essential_packages_g }}"
